!function(){var t="s-map",e=function(){this.finish=0,this.step=0,this.point=0,this.active={x:0,y:0},this.map=[],this.history=[],this.historyStep={},this.viewChange={}};function i(t){var e=new CustomEvent("gameUpdate",{detail:{point:t}});window.dispatchEvent(e)}e.prototype.updateHistoryStep=function(t,e,i){void 0===this.historyStep[e]&&(this.historyStep[e]={}),this.historyStep[e][t]=i},e.prototype.updateHistory=function(){this.history.push(this.historyStep)},e.prototype.updateViewChange=function(t,e,i){void 0===this.viewChange[e]&&(this.viewChange[e]={}),this.viewChange[e][t]=i},e.prototype.updateView=function(){var e,i,a,n,s,o,h,p=document.querySelector("."+t);for(h in this.viewChange)for(o in e=p.querySelectorAll(".s-map__line")[h],this.viewChange[h])for((i=e.querySelectorAll(".s-map__cell")[o]).innerHTML="",n=0,s=(a=this.getElementType(this.viewChange[h][o],o,h)).length;n<s;n++)i.appendChild(this.getElementView(a[n]))},e.prototype.getElementView=function(e){var i=document.createElement("div");return i.className=t+"__"+e,i},e.prototype.updateCell=function(t,e,a){var n=this.map[e][t];1===n&&5===a?this.point--:6===n&&this.point++,this.map[e][t]=n+a,this.updateViewChange(t,e,this.map[e][t]),i(this.point)},e.prototype.updateMap=function(){var t,e,a,n;for(n in this.viewChange)for(a in this.viewChange[n])t=this.map[n][a],e=this.viewChange[n][a],1===t&&6===e?this.point--:6===t&&6!==e&&this.point++,this.map[n][a]=e;i(this.point)},e.prototype.change=function(t){var e,i=Number(this.active.x),a=Number(this.active.y);this.historyStep={},this.viewChange={},this.updateHistoryStep(i,a,this.map[a][i]),i+=Number(t[0]),a+=Number(t[1]),0===(e=this.map[a][i])||1===e?(this.updateHistoryStep(i,a,e),this.move(t,i,a)):5!==e&&6!==e||(this.updateHistoryStep(i,a,e),i+=Number(t[0]),a+=Number(t[1]),0!==(e=this.map[a][i])&&1!==e||(this.updateHistoryStep(i,a,e),this.push(t,i,a)))},e.prototype.over=function(){var t;this.finish=1,t=new CustomEvent("gameOver"),window.dispatchEvent(t)},e.prototype.move=function(t,e,i){this.updateCell(e,i,3),this.active.x=e,this.active.y=i,e-=Number(t[0]),i-=Number(t[1]),this.updateCell(e,i,-3),this.updateView(),this.updateHistory()},e.prototype.push=function(t,e,i){this.updateCell(e,i,5),e-=t[0],i-=t[1],this.updateCell(e,i,-5),this.move(t,e,i),this.point||this.over()},e.prototype.getElementType=function(t,e,i){var a;switch(t){case 1:a=["case"];break;case 3:a=["loader"],this.active.x=e,this.active.y=i;break;case 5:a=["box"];break;case 7:a=["wall"];break;case 6:a=["case_box"];break;case 4:a=["case","loader"],this.active.x=e,this.active.y=i;break;default:a=[]}return a},e.prototype.init=function(e){var a,n,s,o,h,p,r,c,u,l,d,v,m=document.querySelector("."+t),y=this;for(y.map=e,(l=document.createElement("div")).className=t+"__line",(v=document.createElement("div")).className=t+"__cell",a=0,o=y.map.length;a<o;a++){for(u=l.cloneNode(!1),n=0,h=y.map[a].length;n<h;n++){for(r=y.map[a][n],c=y.getElementType(r,n,a),d=v.cloneNode(!1),1!==r&&4!==r||(y.point++,i(y.point)),s=0,p=c.length;s<p;s++)d.appendChild(y.getElementView(c[s]));u.appendChild(d)}m.appendChild(u)}window.addEventListener("keydown",function(t){var e;if(!y.finish){switch(t.keyCode){case 37:e=[-1,0];break;case 38:e=[0,-1];break;case 39:e=[1,0];break;case 40:e=[0,1];break;case 90:if(t.ctrlKey){e=null;var i=y.history.pop();i&&(y.viewChange=i,y.updateMap(),y.updateView(!0))}break;default:e=null}e&&y.change(e)}})},(new e).init([[0,0,7,7,7,7,0],[7,7,7,0,0,7,0],[7,0,5,0,1,7,7],[7,0,5,0,0,0,7],[7,3,7,1,0,0,7],[7,7,7,7,7,7,7]])}();try{new CustomEvent("IE has CustomEvent, but doesn't support constructor")}catch(t){window.CustomEvent=function(t,e){var i;return e=e||{bubbles:!1,cancelable:!1,detail:void 0},(i=document.createEvent("CustomEvent")).initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i},CustomEvent.prototype=Object.create(window.Event.prototype)}
